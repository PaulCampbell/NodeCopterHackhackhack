<!DOCTYPE html>
<html>
<head>
  <title>Follow me</title>
  <script src="jquery-1.8.3.min.js"></script>
</head>
<body>
<ul>
  <li><a id="takeOff" >Take off</a></li>
  <li><a id="clockwise" >Clockwise</a></li>
  <li><a id="anticlockwise" >AntiClockwise</a></li>
  <li><a id="stop">stop</a></li>
  <li><a id="forwards">forwards</a></li>
  <li><a id="backwards">backwards</a></li>

  <li><a id="up">up</a></li>
  <li><a id="down">down</a></li>


  </ul>

<a id="land" style="display:block ;margin:20px;font-weight: bold; padding:10px; color:white; background-color: red">Land</a>

</div>

<img src="" id="pic" />

<canvas id="graphicEqualiser" />

<script>


    // shim!
    navigator.getUserMedia ||
    (navigator.getUserMedia = navigator.mozGetUserMedia ||
    navigator.webkitGetUserMedia || navigator.msGetUserMedia);

    window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       ||
              window.webkitRequestAnimationFrame ||
              window.mozRequestAnimationFrame    ||
              function( callback ){
                window.setTimeout(callback, 1000 / 60);
              };
    })();


  $(document).ready(function(){
      $('#takeOff').click(function(){
        takeOff()
      });

    $('#clockwise').click(function(){
      clockwise();
    });
    $('#anticlockwise').click(function(){
           anticlockwise();
    })

    $('#stop').click(function(){
        stop();
    });

    $('#land').click(function(){
      $.get('/land', function(data) {
              console.log('land');
            });
    });

    $('#up').click(function(){
           upDrone();
       });

    $('#down').click(function(){
      downDrown();
       });

    $('#forwards').click(function(){
 forwardsDrone();
    })

    $('#backwards').click(function(){
    backwardsDrone();
    })

    $('body').keypress(processKeyDown);


    setInterval(function(){
      var date = new Date();
            $('#pic').attr('src', "/picture?date=" + new Date().toString())

    }, 500)




    navigator.getUserMedia({audio:true}, gotAudio);

        function gotAudio(stream) {
          var source =  context.createMediaStreamSource(stream);
          source.connect(analyser);

          rafCallback();
        }

    var graphicEqualiserCanvas = document.getElementById('graphicEqualiser');
    var context = new webkitAudioContext();
     var analyser = context.createAnalyser();

    function getAverageVolume(array) {
       var values = 0;
       var average;
       var length = array.length;
       for (var i = 0; i < length; i++) {
           values += array[i];
       }
       average = values / length;
       return average;
     }

  function processKeyDown(event){
    console.log(event.keyCode);
    switch (event.keyCode){
      case 119: // w
        forwardsDrone();
        break;
      case 120: // x
        backwardsDrone();
        break;
      case 97: // a
        leftDrone();
        break;
      case 100: // d
        rightDrone();
        break;
      case 117: // u
        upDrone();
        break;
      case 110: // n
        downDrone();
        break;
      case 32: // space
        landDrone();
        break;
      case 13: // enter
        takeOff();
        break;
      case 115:
        stop();
        break;
    }
  }

  function rafCallback(time) {

    requestAnimFrame(rafCallback, graphicEqualiserCanvas);
      var freqByteData = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(freqByteData);

      //set volume
      var volume = getAverageVolume(freqByteData);

      if(volume > 250) {
        console.log(volume);
        $.get('/land', function(data) {
               console.log('land');
             });
      }
    }


  function takeOff(){
    console.log('taking off')
            $.get('/takeoff', function(data) {
              console.log('take off');
            });

  }

  function clockwise(){
    $.get('/clockwise', function(data) {
                    console.log('clockwise');
                  });
  }

  function anticlockwise() {
      $.get('/anticlockwise', function(data) {
        console.log('anticlockwise');
      })
  }

  function stop(){
    $.get('/stop', function(data) {
                      console.log('stop');
                    });
  }

  function landDrone() {
    $.get('/land', function(data) {
        console.log('land');
      });
  }

  function upDrone() {
    $.get('/up', function(data) {
                  console.log('up');
                });
  }

  function downDrown() {
    $.get('/down', function(data) {
                   console.log('down');
                 });
  }

  function forwardsDrone(){
    $.get('/forwards', function(data) {
           console.log('forwards');
         });
  }

  function backwardsDrone(){
    $.get('/backwards', function(data) {
              console.log('backwards');
            });
  }

  function leftDrone(){
     $.get('/left', function(data) {
               console.log('left');
             });
   }

  function rightDrone(){
       $.get('/right', function(data) {
         console.log('right');
       });
     }
  })
</script>
</body>
</html>